generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  USER
  ADMIN
}

model User {
  id Int @id @default(autoincrement())

  email        String    @unique
  username     String
  points       Int       @default(0)
  role         UserRole  @default(USER)
  isActive     Boolean   @default(true)
  lastLogoutAt DateTime?

  bets         Bet[]
  transactions Transaction[]

  @@index([points])
}

model Team {
  id Int @id @default(autoincrement())

  sportId Int
  name    String
  members String[] // not necessarily users

  // Relations
  sport   Sport       @relation(fields: [sportId], references: [id])
  bets    Bet[]
  matches MatchTeam[]

  @@index([sportId])
}

model Match {
  id Int @id @default(autoincrement())

  startDate DateTime
  endDate   DateTime
  sportId   Int
  isSettled Boolean  @default(false)

  // Participated teams
  teams MatchTeam[] // 2 teams if ONE_ON_ONE

  // Other relations
  sport Sport @relation(fields: [sportId], references: [id])
  bets  Bet[]

  @@index([startDate])
}

model MatchTeam {
  teamId  Int
  matchId Int

  score Int? // once recorded, winner calculated in app layer

  // relations
  match Match @relation(fields: [matchId], references: [id])
  team  Team  @relation(fields: [teamId], references: [id])

  @@id([teamId, matchId])
  @@index([matchId, score])
}

enum BetStatus {
  UNSETTLED
  WIN
  LOSE
  REFUNDED
}

model Bet {
  id Int @id @default(autoincrement())

  userId  Int
  matchId Int

  createdAt  DateTime  @default(now())
  predTeamId Int? // null = draw, int = teamid
  status     BetStatus @default(UNSETTLED)
  stake      Float

  // Relations
  match    Match @relation(fields: [matchId], references: [id])
  user     User  @relation(fields: [userId], references: [id])
  predTeam Team? @relation(fields: [predTeamId], references: [id])

  @@unique([userId, matchId])
}

enum TransactionSource {
  BET
  OTHER
}

model Transaction {
  id Int @id @default(autoincrement())

  userId    Int
  amount    Int
  issueDate DateTime @default(now())

  source      TransactionSource
  description String?
  referenceId Int?

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId, issueDate])
}

enum SportFormat {
  ONE_ON_ONE
  FFA
}

enum ScoreOrdering {
  ASC
  DESC
}

model Sport {
  id Int @id @default(autoincrement())

  name     String        @unique
  format   SportFormat
  ordering ScoreOrdering

  // Relations
  matches Match[]
  teams   Team[]
}
